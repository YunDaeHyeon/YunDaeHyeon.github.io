---
layout: post
title:  "[Spring] Spring Security를 이용하여 회원가입하기"
date:   2022-02-06 00:12:31+0900
categories: jekyll update
tags: [spring]
---
# 스프링 시큐리티(Spring Security)를 이용한 회원가입 처리
**스프링 시큐리티(Spring Security)**를 이해하기 위해서는 말보다는 직접 코드를 작성하면서 학습하는 것이 좋다고 생각하여 작성한다.
스프링 시큐리티(Spring Security)를 이용하여 회원가입 처리를 만든 뒤, 로그인 처리까지 구현을 할 예정이다.  
<p align="center"><img src="/assets/img/blog/정보/spring security.png"></p>

# 스프링 시큐리티(Spring Security)를 왜 사용하나?
1. **모든 Request URL에 대한 인증을 요구한다.**  
2. 개발자가 따로 구현을 하지 않아도 로그인 폼과 로그아웃 처리를 해준다.  
3. **CSRF** 공격을 방어한다.  
4. Request 헤더를 보안한다.  
5. 서블릿(Servlet) API 메소드를 통합한다.  
6. **편리한 권한 체계를 구축할 수 있다.**  
스프링 시큐리티(Spring Security)를 사용하는 이유는 다양하다. 개인적인 생각이지만 스프링 시큐리티가 아닌 개발자가 직접적으로 보안 로직을 하나하나
 작성하기에는 너무 번거롭고 나같은 초보자에겐 많이 어렵다고 생각이 든다. 사용하기 까지 어렵더라도 강력하고 편리한 프레임워크를 사용을 하여 나만의 애플리케이션을 더욱 견고하게 만들 수 있다면 충분히 사용할 가치가 많다고 생각한다.

# 환경 설정
! 스프링 시큐리티(Spring Security)를 사용하기 위해서는 `JDK 1.8`이상 이거나 `Gradle 4 이상 또는 Maven 3.2 이상`이어야 한다.  

```java
implementation 'org.springframework.boot:spring-boot-starter-security'
implementation 'org.springframework.security:spring-security-test'
! Gradle을 사용한다면 위의 의존성 추가. (메인 스타터와 테스트 전용)
```
  
```java
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-security</artifactId>
</dependency>
<dependency>
  <groupId>org.springframework.security</groupId>
  <artifactId>spring-security-test</artifactId>
  <scope>test</scope>
</dependency>
! Maven을 사용한다면 위의 의존성 추가.
```

실습하면서 사용한 툴과 Spring의 버전은 다음과 같다.  
`Spring Boot Version : 2.6.3`  
`IntelliJ IDEA Ultimate`  
---  
**의존성**은 다음과 같이 추가하였다.  
`Spring Web`, `Spring Data JPA`, `Lombok`, `Thymeleaf`, `Mybatis`, `MySQL Driver`

# 실습을 위한 DB 작성
**스프링 시큐리티(Spring Security)**의 실습을 위한 DB 테이블을 단순하게 만들어봤다.  
```sql
CREATE TABLE test(
    user_number int(10) not null auto_increment comment '식별번호',
    user_id varchar(100) not null comment '아이디',
    user_password varchar(100) not null comment '비밀번호',
    user_name varchar(100) not null comment '이름',
    user_auth varchar(100) not null comment '권한',
    created_date datetime default null comment '계정 생성 날짜',
    primary key(user_number)
)
! 오직 실습을 위한 Table이다.
```
실습 중에는 DB의 경우 **스네이크 표기법**을, 자바는 **카멜 표기법**을 사용한다.  

# application.properties 설정
**! yml을 사용해도 무관하다. 하지만 해당 포스팅은 `properties`를 사용한다.**  

```java
spring.datasource.hikari.driver-class-name=com.mysql.cj.jdbc.Driver
spring.datasource.hikari.jdbc-url=jdbc:mysql://localhost:3306/DB이름
spring.datasource.hikari.username=아이디
spring.datasource.hikari.password=비밀번호

mybatis.configuration.map-underscore-to-camel-case=true
! application.properties 파일
```
실습을 하기 위하여 `hikariCP`를 사용하였고 `mybatis`의 `map-underscore-to-camel-case`값을 `true`로 바꿔주었다.  
*properties에서 작성한 정보들을 configuration에서 지정해야한다. 해당 게시글에서는 넘어가겠다.*

# 프로젝트 configuration 작성
```java
package test.configuration;
// * 생략 *
@Configuration
@PropertySource("classpath:/application.properties")
// application.properties를 사용할 수 있도록 해당 파일의 위치를 지정한다.
public class TestConfiguration {

    @Autowired
    private ApplicationContext applicationContext;
    // * 생략 *
    @Bean
    public SqlSessionFactory sqlSessionFactory(DataSource dataSource) throws Exception{
        SqlSessionFactoryBean sqlSessionFactoryBean = new SqlSessionFactoryBean();
        sqlSessionFactoryBean.setDataSource(dataSource);
        sqlSessionFactoryBean.setMapperLocations(applicationContext.getResources("classpath:/sqlquery/**/*.xml"));

        sqlSessionFactoryBean.setConfiguration(mybatisConfig());

        return sqlSessionFactoryBean.getObject();
    }
    // * 생략 *
}
```
**configuration을** 모아놓기 위해 test 패키지 밑에 configuration 패키지를 하나 만들어서 `TestConfiguration` 이라는 클래스를 만들었다.  
`sqlSessionFactory` 메서드에서 `sqlSessionFactoryBean.setMapperLocations`를 사용하였는데 이는 **MyBatis의 매퍼(Mapper) 파일의 위치**를 설정한다. `classpath:/sqlquery/**/*.xml`의 **classpath**는 프로젝트의 `resource` 폴더를 의미하며 **sqlquery/**\**/은 `resource` 폴더 밑 **sqlquery 폴더 하위의 모든 폴더**를 의미한다. 마지막으로 `\*.xml`은 확장자가 **\*.xml인 모든 파일을 의미**한다.  
  
이를 종합하면 해당 코드의 의미는 **매퍼(Mapper)와 연동되는 xml 파일의 위치는 resouece/sqlquery/ 에 있는 확장자 .xml로 끝나는 파일이다.** 라는 뜻이다.

# 로그인, 회원가입 페이지
```html
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <html lang="ko" xmlns:th="http://www.thymeleaf.org"></html>
    <title>Login</title>
</head>
<style>
    table{
        margin-left: auto;
        margin-right: auto;
    }
    body{
        text-align: center;
    }
</style>
<body>
    <div class="container">
        <h2>로그인</h2>
        <form method="post" th:action="@{/login_action}">
            <table class="login_table">
                <tr>
                    <td>아이디</td>
                    <td><input type="text"name="userId" placeholder="아이디"></td>
                </tr>
                <tr>
                    <td>비밀번호</td>
                    <td><input type="password"name="userPassword" placeholder="비밀번호"></td>
                </tr>
            </table>
            <button type="submit">로그인</button>
            <button type="button" onclick="location.href='registerpage'">회원가입</button>
        </form>
    </div>
</body>
</html>
! 로그인 페이지 templates/loginpage.html
```
<p align="center"><img src="/assets/img/blog/정보/로그인.png"></p>
```html
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <html lang="ko" xmlns:th="http://www.thymeleaf.org"></html>
    <title>Register</title>
</head>
<style>
    table{
        margin-left: auto;
        margin-right: auto;
    }
    body{
        text-align: center;
    }
</style>
<body>
    <div class="container">
        <h2>회원가입</h2>
        <form method="post" action="/register_action">
            <table class="login_table">
                <tr>
                    <td>아이디</td>
                    <td><input type="text"name="userId" placeholder="아이디"></td>
                </tr>
                <tr>
                    <td>이름</td>
                    <td><input type="text"name="userName" placeholder="이름"></td></td>
                </tr>
                <tr>
                    <td>비밀번호</td>
                    <td><input type="password"name="userPassword" placeholder="비밀번호"></td>
                </tr>
            </table>
            <button type="submit">가입</button>
        </form>
    </div>
</body>
</html>
! 회원가입 페이지 templates/registerpage.html
```
<p align="center"><img src="/assets/img/blog/정보/회원가입.png"></p>